<div class="car-details-page">
  <div class="header-section">
    <button class="back-btn" (click)="goBack()">
      <svg
        class="icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
      Back to My Vehicles
    </button>
    <div class="title-section" *ngIf="vehicle">
      <div class="title-with-logo">
        <img
          *ngIf="getCarLogo(vehicle.make)"
          [src]="getCarLogo(vehicle.make)"
          [alt]="vehicle.make + ' Logo'"
          class="brand-logo"
          (error)="$event.target.style.display = 'none'"
        />
        <h1>{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}</h1>
      </div>
    </div>
    <button class="edit-btn" (click)="editCarAndIndicators()">
      <svg
        class="icon"
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
      Edit Car and Indicators
    </button>
  </div>

  <!-- Quick Actions Bar -->
  <div class="quick-actions-bar" *ngIf="vehicle">
    <button class="action-btn primary">
      <svg
        class="icon"
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      Schedule Maintenance
    </button>
    <!-- Export PDF moved to take the place of the removed Add Expense button -->
    <button class="action-btn secondary" (click)="exportToPDF()">
      <svg
        class="icon"
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      Export PDF
    </button>
  </div>

  <!-- Summary Overview Card -->
  <div class="summary-overview" *ngIf="vehicle">
    <div class="summary-card status-good">
      <div class="summary-icon">
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="summary-content">
        <h3>{{ getGoodCount() }}</h3>
        <p>All Good</p>
      </div>
    </div>
    <div class="summary-card status-attention">
      <div class="summary-icon">
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
          ></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
      </div>
      <div class="summary-content">
        <h3>{{ getAttentionCount() }}</h3>
        <p>Need Attention</p>
      </div>
    </div>
    <div class="summary-card status-urgent">
      <div class="summary-icon">
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <div class="summary-content">
        <h3>{{ getUrgentCount() }}</h3>
        <p>Urgent</p>
      </div>
    </div>
    <div class="summary-card mileage-card">
      <div class="summary-icon">
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <div class="summary-content">
        <h3>{{ vehicle.currentMileage | number }}</h3>
        <p>Current Mileage (km)</p>
      </div>
    </div>
  </div>

  <div class="content-grid" *ngIf="vehicle">
    <!-- Left Column: Car Image and Vehicle Information -->
    <div class="left-column">
      <!-- Car Image with loading state -->
      <div class="car-image-section">
        <img
          [src]="vehicle.imageUrl"
          [alt]="vehicle.year + ' ' + vehicle.make + ' ' + vehicle.model"
          class="car-image"
          loading="eager"
        />
      </div>

      <!-- Vehicle Information (vertical list) -->
      <ng-container *ngIf="vehicle as currentVehicle">
        <app-vehicle-info
          [vehicleId]="currentVehicle.id"
          (mileageLoaded)="updateMileage($event)"
          (infoLoaded)="updateVehicleInfo($event)"
        ></app-vehicle-info>
      </ng-container>
    </div>

    <!-- Right Column: Condition Indicators (PRIORITY) and Maintenance -->
    <div class="right-column">
      <!-- CONDITION INDICATORS - TOP PRIORITY -->
      <div class="condition-indicators-section">
        <div id="vehicle-health-status" class="section-header-main">
          <div class="header-left">
            <div class="section-icon-modern">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
              </svg>
            </div>
            <div>
              <h2>Vehicle Health Status</h2>
              <span class="section-subtitle"
                >{{ getUpcomingServicesCount() }} services needed soon</span
              >
            </div>
          </div>
          <!-- Replace health score with Add Indicator CTA -->
          <div class="add-indicator-wrapper">
            <button
              class="action-btn primary add-indicator-btn"
              (click)="editCarAndIndicators()"
              title="Add or edit indicators"
            >
              <span class="plus-icon">+</span>
              <span class="btn-text">Add Indicator</span>
            </button>
          </div>
        </div>

        <!-- Loading Skeleton for Indicators -->
        <div class="indicators-compact-grid" *ngIf="isLoadingIndicators">
          <div class="indicator-skeleton" *ngFor="let i of [1, 2, 3, 4, 5, 6]">
            <div class="skeleton-header">
              <div class="skeleton-icon"></div>
              <div class="skeleton-info">
                <div class="skeleton-title"></div>
                <div class="skeleton-meta"></div>
              </div>
              <div class="skeleton-status"></div>
            </div>
          </div>
        </div>

        <!-- Simplified Indicators Grid - Compact View -->
        <div class="indicators-compact-grid" *ngIf="!isLoadingIndicators">
          <div
            *ngFor="let indicator of getSortedIndicators(); let i = index"
            class="indicator-compact-card"
            [ngClass]="getStatusClass(indicator.status)"
            (click)="toggleIndicator(i)"
          >
            <div class="indicator-compact-header">
              <div class="indicator-icon-small">{{ indicator.icon }}</div>
              <div class="indicator-compact-info">
                <h4>{{ indicator.name }}</h4>
                <div class="indicator-meta">
                  <span class="next-service">{{ indicator.nextInspectionDate }}</span>
                  <span
                    class="remaining-mini"
                    [ngClass]="getRemainingUrgencyClass(indicator.remaining, indicator.type)"
                  >
                    {{ getRemainingDisplay(indicator) }}
                  </span>
                </div>
              </div>
              <div class="indicator-status-and-expand">
                <div class="indicator-status-icon">
                  <svg
                    *ngIf="indicator.status === 'Normal'"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#10b981"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <svg
                    *ngIf="indicator.status === 'Warning'"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#f59e0b"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                    ></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg>
                  <svg
                    *ngIf="indicator.status === 'Critical'"
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#ef4444"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                  </svg>
                </div>
                <div class="expand-indicator" [class.expanded]="expandedIndicators.has(i)">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Expanded Details (only when clicked) -->
            <div class="indicator-compact-details" *ngIf="expandedIndicators.has(i)">
              <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span
                  class="detail-value status-text"
                  [ngClass]="getStatusClass(indicator.status)"
                  >{{ indicator.status }}</span
                >
              </div>
              <div class="detail-row">
                <span class="detail-label">
                  <svg
                    class="detail-icon"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                    <path d="M2 17l10 5 10-5"></path>
                    <path d="M2 12l10 5 10-5"></path>
                  </svg>
                  Remaining Mileage:
                </span>
                <span class="detail-value">{{ indicator.mileageDifference | number }} km</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">
                  <svg
                    class="detail-icon"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  Remaining Time:
                </span>
                <span class="detail-value">{{
                  formatTimeDifference(indicator.timeDifference)
                }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">
                  <svg
                    class="detail-icon"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  Remaining Time (%):
                </span>
                <span
                  class="detail-value"
                  [ngClass]="getPercentageClass(indicator.timeDifferenceAsPercentage)"
                >
                  {{ indicator.timeDifferenceAsPercentage | number : '1.1-1' }}%
                </span>
              </div>
              <div class="detail-row">
                <span class="detail-label">
                  <svg
                    class="detail-icon"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                  Estimated Cost:
                </span>
                <span class="detail-value">{{ getServiceCost(indicator) }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">
                  <svg
                    class="detail-icon"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  Recommended:
                </span>
                <span class="detail-value">{{ getRecommendedProvider(indicator) }}</span>
              </div>
              <div class="detail-actions">
                <button
                  class="compact-action-btn primary"
                  (click)="scheduleService(indicator); $event.stopPropagation()"
                >
                  Schedule
                </button>
                <button
                  class="compact-action-btn secondary"
                  (click)="shareIndicator(indicator); $event.stopPropagation()"
                >
                  Share
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Expenses Tracker Section -->
      <div class="expenses-section">
        <div class="expenses-header">
          <div>
            <h2 class="section-title">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="display: inline; vertical-align: middle; margin-right: 8px"
              >
                <rect x="2" y="5" width="20" height="14" rx="2" />
                <line x1="2" y1="10" x2="22" y2="10" />
              </svg>
              Expenses Tracker
            </h2>
            <p class="section-subtitle">Track fuel, maintenance, and other costs</p>
          </div>
          <button class="add-expense-btn" (click)="openAddExpenseModal()">+ Add Expense</button>
        </div>
        <div class="expense-list">
          <div *ngIf="expenses.length === 0" class="no-expenses">
            <p>No expenses recorded yet. Click "+ Add Expense" to get started!</p>
          </div>
          <div *ngFor="let expense of expenses" class="expense-item">
            <div class="expense-icon">{{ expense.icon }}</div>
            <div class="expense-info">
              <h4>{{ expense.name }}</h4>
              <p class="expense-meta">
                <span class="expense-date">{{ expense.date | date : 'MMM dd, yyyy' }}</span>
                <span class="expense-description" *ngIf="expense.description">{{
                  expense.description
                }}</span>
              </p>
            </div>
            <div class="expense-actions">
              <span class="expense-amount">EGP {{ expense.amount | number : '1.2-2' }}</span>
              <button
                class="delete-expense-btn"
                title="Delete expense"
                (click)="deleteExpense(expense.id)"
                [disabled]="expense.id && deletingExpenseIds.has(expense.id)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 448 512"
                  width="14"
                  height="14"
                  aria-hidden="false"
                  focusable="false"
                >
                  <path
                    fill="currentColor"
                    d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64v32c0 8.8 7.2 16 16 16h416c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32H320l-7.2-14.3C307.6 6 296.9 0 285 0H163c-11.9 0-22.6 6-27.8 17.7zM53.2 467c1.5 25.7 22.9 45 48.6 45h243.5c25.7 0 47.1-19.3 48.6-45L416 128H32l21.2 339z"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Expense Modal -->
      <div *ngIf="isAddExpenseModalOpen" class="modal-overlay" (click)="closeAddExpenseModal()">
        <div class="modal-container" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>Add New Expense</h3>
            <button class="modal-close-btn" (click)="closeAddExpenseModal()">âœ•</button>
          </div>
          <div
            *ngIf="expenseMessage"
            class="alert"
            [ngClass]="expenseMessageType === 'success' ? 'success' : 'error'"
          >
            {{ expenseMessage }}
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="expense-type">Expense Type</label>
              <select
                id="expense-type"
                [(ngModel)]="newExpenseForm.expenseType"
                (change)="updateExpenseType(newExpenseForm.expenseType)"
                class="form-input"
                required
                #typeModel="ngModel"
              >
                <option value="" disabled>Select Expense Type</option>
                <option *ngFor="let type of expenseTypes" [value]="type">{{ type }}</option>
              </select>
              <div class="field-error" *ngIf="submittedExpense && typeModel.invalid">
                Expense type is required.
              </div>
            </div>
            <div class="form-group">
              <label for="expense-date">Date</label>
              <input
                id="expense-date"
                type="date"
                [(ngModel)]="newExpenseForm.expenseDate"
                class="form-input"
              />
            </div>
            <div class="form-group">
              <label for="expense-amount">Amount (EGP)</label>
              <input
                id="expense-amount"
                type="number"
                min="0.01"
                step="0.01"
                [(ngModel)]="newExpenseForm.amount"
                placeholder="0.00"
                class="form-input"
                required
                #amountModel="ngModel"
              />
              <div
                class="field-error"
                *ngIf="
                  submittedExpense && (amountModel.invalid || (newExpenseForm.amount ?? 0) <= 0)
                "
              >
                Amount must be greater than 0.
              </div>
            </div>
            <div class="form-group">
              <label for="expense-desc">Description</label>
              <textarea
                id="expense-desc"
                rows="3"
                class="form-input"
                [(ngModel)]="newExpenseForm.description"
                placeholder="Optional description..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              class="btn-cancel"
              (click)="closeAddExpenseModal()"
              [disabled]="isSavingExpense"
            >
              Cancel
            </button>
            <button class="btn-save" (click)="addExpense()" [disabled]="isSavingExpense">
              Add Expense
            </button>
          </div>
        </div>
      </div>

      <!-- Maintenance Overview - Secondary Information -->
      <div class="maintenance-info-section">
        <div class="section-header">
          <div class="section-icon-modern small">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
              ></path>
            </svg>
          </div>
          <span>Maintenance Overview</span>
        </div>

        <!-- Circular Progress Gauge -->
        <div class="progress-gauge-container">
          <div class="circular-gauge">
            <svg viewBox="0 0 200 200" class="gauge-svg">
              <circle cx="100" cy="100" r="85" class="gauge-background" />
              <circle
                cx="100"
                cy="100"
                r="85"
                class="gauge-progress"
                [style.stroke-dasharray]="getMileageCircumference()"
                [style.stroke-dashoffset]="getMileageProgress()"
                [ngClass]="getMileageUrgencyClass()"
              />
            </svg>
            <div class="gauge-center">
              <div class="gauge-remaining-top">{{ getRemainingKm() | number }}</div>
              <div class="gauge-remaining-label">km until service</div>
              <div class="gauge-divider"></div>
              <div class="gauge-value" (click)="editMileage = !editMileage">
                <input
                  *ngIf="editMileage"
                  type="number"
                  [(ngModel)]="vehicle.currentMileage"
                  (blur)="saveMileage()"
                  (keyup.enter)="saveMileage()"
                  class="mileage-input"
                />
                <span *ngIf="!editMileage">{{ vehicle.currentMileage | number }}</span>
              </div>
              <div class="gauge-label">km traveled</div>
            </div>
          </div>
        </div>

        <!-- Maintenance History Timeline -->
        <div class="service-history">
          <div class="history-header">
            <h3>
              <svg
                class="history-icon"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              Maintenance History
            </h3>
            <span class="history-count" *ngIf="bookingServiceHistory.length > 0">
              {{ bookingServiceHistory.length }}
              {{ bookingServiceHistory.length === 1 ? 'maintenance' : 'maintenances' }}
            </span>
          </div>

          <!-- Loading State -->
          <div class="service-history-loading" *ngIf="isLoadingServiceHistory">
            <div class="loading-spinner"></div>
            <span>Loading maintenance history...</span>
          </div>

          <!-- Error State -->
          <div
            class="service-history-error"
            *ngIf="serviceHistoryError && !isLoadingServiceHistory"
          >
            <svg
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <h4>Unable to Load Service History</h4>
            <p>We're having trouble retrieving your service records at the moment. This could be due to a temporary connection issue. Please try again or contact support if the problem persists.</p>
            <button class="retry-btn" (click)="loadServiceHistory()">Retry</button>
          </div>

          <!-- Empty State -->
          <div
            class="service-history-empty"
            *ngIf="
              !isLoadingServiceHistory && !serviceHistoryError && bookingServiceHistory.length === 0
            "
          >
            <div class="empty-icon">
              <svg
                width="56"
                height="56"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"
                ></path>
                <rect x="9" y="3" width="6" height="4" rx="1"></rect>
                <path d="M9 12h6"></path>
                <path d="M9 16h6"></path>
              </svg>
            </div>
            <h4>No Maintenance History Yet</h4>
            <p>Completed bookings with reviews will appear here</p>
          </div>

          <!-- Service History List -->
          <div
            class="service-history-scroll"
            *ngIf="
              !isLoadingServiceHistory && !serviceHistoryError && bookingServiceHistory.length > 0
            "
          >
            <div class="service-cards">
              <div
                *ngFor="let service of bookingServiceHistory; let i = index"
                class="service-card"
                [class.latest]="i === 0"
              >
                <!-- Card Number Badge -->
                <div class="card-number">{{ bookingServiceHistory.length - i }}</div>

                <!-- Card Header -->
                <div class="card-header">
                  <div class="service-name">
                    <svg
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                      ></path>
                    </svg>
                    <span>{{ service.serviceName }}</span>
                  </div>
                  <div class="service-amount-wrapper">
                    <span class="latest-badge" *ngIf="i === 0">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor">
                        <polygon
                          points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                        ></polygon>
                      </svg>
                      Latest
                    </span>
                    <div class="service-amount">{{ service.reviewPaidAmount | number }} EGP</div>
                  </div>
                </div>

                <!-- Service Description -->
                <div class="service-desc" *ngIf="service.serviceDescription">
                  {{ service.serviceDescription }}
                </div>

                <!-- Card Footer -->
                <div class="card-footer">
                  <div class="footer-item date">
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    {{ formatServiceDate(service.appointmentDate) }}
                  </div>
                  <div class="footer-divider"></div>
                  <div class="footer-item booking-ref">
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                      <path
                        d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                      ></path>
                    </svg>
                    Maintenance #{{ bookingServiceHistory.length - i }}
                  </div>
                </div>

                <!-- Issue Note -->
                <div class="issue-note" *ngIf="service.issueDescription">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                  </svg>
                  <span>{{ service.issueDescription }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cost Analytics Dashboard -->
        <div class="cost-tracking">
          <div class="analytics-header">
            <h3>
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
              </svg>
              Cost Analytics
            </h3>
            <div
              class="trend-badge"
              [class.up]="getSpendingTrend() === 'up'"
              [class.down]="getSpendingTrend() === 'down'"
            >
              <svg
                *ngIf="getSpendingTrend() === 'up'"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
              </svg>
              <svg
                *ngIf="getSpendingTrend() === 'down'"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                <polyline points="17 18 23 18 23 12"></polyline>
              </svg>
              <svg
                *ngIf="getSpendingTrend() === 'stable'"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              {{
                getSpendingTrend() === 'up'
                  ? 'Increasing'
                  : getSpendingTrend() === 'down'
                  ? 'Decreasing'
                  : 'Stable'
              }}
            </div>
          </div>

          <!-- Grand Total Card -->
          <div class="grand-total-card">
            <div class="total-main">
              <div class="total-icon">
                <svg
                  width="32"
                  height="32"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
              </div>
              <div class="total-text">
                <span class="total-label">Total Car Expenses</span>
                <span class="total-value">{{ getGrandTotal() | number }} EGP</span>
              </div>
            </div>
            <div class="total-breakdown">
              <div class="breakdown-item maintenance">
                <div class="breakdown-icon-wrapper">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                    ></path>
                  </svg>
                </div>
                <div class="breakdown-info">
                  <span class="breakdown-label">Maintenance</span>
                  <span class="breakdown-value">{{ getTotalMaintenanceCost() | number }} EGP</span>
                </div>
                <div class="breakdown-badge">{{ getMaintenancePercentage() }}%</div>
              </div>
              <div class="breakdown-divider"></div>
              <div class="breakdown-item expenses">
                <div class="breakdown-icon-wrapper expenses-icon">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                  </svg>
                </div>
                <div class="breakdown-info">
                  <span class="breakdown-label">Other Expenses</span>
                  <span class="breakdown-value">{{ getTotalExpensesCost() | number }} EGP</span>
                </div>
                <div class="breakdown-badge">{{ getExpensesPercentage() }}%</div>
              </div>
            </div>
          </div>

          <!-- Donut Chart & Stats -->
          <div class="analytics-row">
            <!-- Donut Chart -->
            <div class="donut-chart-container">
              <div class="donut-chart">
                <svg viewBox="0 0 36 36" class="circular-chart">
                  <path
                    class="circle-bg"
                    d="M18 2.0845
                      a 15.9155 15.9155 0 0 1 0 31.831
                      a 15.9155 15.9155 0 0 1 0 -31.831"
                  />
                  <path
                    class="circle maintenance-circle"
                    [attr.stroke-dasharray]="getMaintenancePercentage() + ', 100'"
                    d="M18 2.0845
                      a 15.9155 15.9155 0 0 1 0 31.831
                      a 15.9155 15.9155 0 0 1 0 -31.831"
                  />
                  <path
                    class="circle expenses-circle"
                    [attr.stroke-dasharray]="getExpensesPercentage() + ', 100'"
                    [attr.stroke-dashoffset]="-getMaintenancePercentage()"
                    d="M18 2.0845
                      a 15.9155 15.9155 0 0 1 0 31.831
                      a 15.9155 15.9155 0 0 1 0 -31.831"
                  />
                </svg>
                <div class="donut-center">
                  <span class="donut-total">{{ getGrandTotal() | number }}</span>
                  <span class="donut-label">EGP Total</span>
                </div>
              </div>
              <div class="donut-legend">
                <div class="legend-item">
                  <span class="legend-color maintenance"></span>
                  <span>Maintenance ({{ getMaintenancePercentage() }}%)</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color expenses"></span>
                  <span>Expenses ({{ getExpensesPercentage() }}%)</span>
                </div>
              </div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
              <div class="stat-card">
                <div class="stat-icon blue">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                </div>
                <div class="stat-content">
                  <span class="stat-number">{{ getMaintenanceCount() }}</span>
                  <span class="stat-label">Maintenances</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon green">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                  </svg>
                </div>
                <div class="stat-content">
                  <span class="stat-number">{{ getExpensesCount() }}</span>
                  <span class="stat-label">Expenses</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon orange">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                </div>
                <div class="stat-content">
                  <span class="stat-number">{{ getMonthlyAverage() | number }}</span>
                  <span class="stat-label">Avg/Month</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon purple">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </div>
                <div class="stat-content">
                  <span class="stat-number">{{ getDaysSinceLastMaintenance() }}</span>
                  <span class="stat-label">Days Ago</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Monthly Trend Chart -->
          <div class="monthly-chart">
            <div class="chart-header">
              <h4>Monthly Spending Trend</h4>
              <span class="chart-period">Last 6 Months</span>
            </div>
            <div class="chart-area">
              <div class="chart-bars">
                <div
                  *ngFor="let month of getCostHistory(); let i = index"
                  class="chart-bar-wrapper"
                  [class.highest]="month.cost === getHighestSpendingMonth().cost && month.cost > 0"
                >
                  <div class="chart-bar-value">{{ month.cost | number }}</div>
                  <div class="chart-bar" [style.height.%]="getBarHeight(month.cost)">
                    <div class="bar-fill" [class.empty]="month.cost === 0"></div>
                  </div>
                  <div class="chart-bar-label">{{ month.month }}</div>
                </div>
              </div>
              <div class="chart-baseline"></div>
            </div>
          </div>

          <!-- Spending Breakdown by Type -->
          <div class="spending-breakdown" *ngIf="getExpensesByType().length > 0">
            <h4>Spending by Category</h4>
            <div class="breakdown-bars">
              <div *ngFor="let item of getExpensesByType()" class="breakdown-bar-item">
                <div class="breakdown-bar-header">
                  <span class="breakdown-bar-icon">{{ item.icon }}</span>
                  <span class="breakdown-bar-type">{{ item.type }}</span>
                  <span class="breakdown-bar-amount">{{ item.amount | number }} EGP</span>
                </div>
                <div class="breakdown-bar-track">
                  <div class="breakdown-bar-fill" [style.width.%]="item.percentage"></div>
                </div>
                <span class="breakdown-bar-percentage">{{ item.percentage }}%</span>
              </div>
            </div>
          </div>

          <!-- Insights Cards -->
          <div class="insights-row">
            <div class="insight-card highest">
              <div class="insight-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                  <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
              </div>
              <div class="insight-content">
                <span class="insight-label">Highest Month</span>
                <span class="insight-value">{{ getHighestSpendingMonth().month }}</span>
                <span class="insight-amount"
                  >{{ getHighestSpendingMonth().cost | number }} EGP</span
                >
              </div>
            </div>
            <div class="insight-card lowest">
              <div class="insight-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                  <polyline points="17 18 23 18 23 12"></polyline>
                </svg>
              </div>
              <div class="insight-content">
                <span class="insight-label">Lowest Month</span>
                <span class="insight-value">{{ getLowestSpendingMonth().month }}</span>
                <span class="insight-amount">{{ getLowestSpendingMonth().cost | number }} EGP</span>
              </div>
            </div>
            <div class="insight-card last-service">
              <div class="insight-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path
                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                  ></path>
                </svg>
              </div>
              <div class="insight-content">
                <span class="insight-label">Last Maintenance</span>
                <span class="insight-value">{{ getLastMaintenanceDate() }}</span>
                <span class="insight-amount" *ngIf="getDaysSinceLastMaintenance() > 0"
                  >{{ getDaysSinceLastMaintenance() }} days ago</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule Maintenance Button -->
        <button class="schedule-maintenance-btn" (click)="scheduleMaintenanceDialog()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Schedule Maintenance Now
        </button>
      </div>
    </div>
  </div>
</div>
