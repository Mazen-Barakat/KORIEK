<div class="booking-page">
  <div class="booking-container">
    <!-- Header (hidden on success step) -->
    <div class="booking-header" *ngIf="currentStep !== 5">
      <h1>Book a Service</h1>
      <p class="subtitle">Schedule maintenance with verified workshops</p>

      <!-- Progress Stepper for PRESELECTED flow (3 steps: Service → Date & Time → Review) -->
      <div class="progress-stepper" *ngIf="hasPreselectedService()">
        <div
          class="step"
          [class.active]="currentStep === 1"
          [class.completed]="currentStep > 1"
          (click)="goToStep(1)"
        >
          <div class="step-circle">
            <svg
              *ngIf="currentStep > 1"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <span *ngIf="currentStep <= 1">1</span>
          </div>
          <span class="step-label">Vehicle & Details</span>
        </div>

        <div class="step-line" [class.completed]="currentStep > 1"></div>

        <div
          class="step"
          [class.active]="currentStep === 2"
          [class.completed]="currentStep > 2"
          (click)="goToStep(2)"
        >
          <div class="step-circle">
            <svg
              *ngIf="currentStep > 2"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <span *ngIf="currentStep <= 2">2</span>
          </div>
          <span class="step-label">Date & Time</span>
        </div>

        <div class="step-line" [class.completed]="currentStep > 2"></div>

        <div class="step" [class.active]="currentStep === 4" [class.completed]="currentStep > 4">
          <div class="step-circle">
            <svg
              *ngIf="currentStep > 4"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <span *ngIf="currentStep <= 4">3</span>
          </div>
          <span class="step-label">Review</span>
        </div>
      </div>

      <!-- Progress Stepper for NORMAL flow (4 steps) -->
      <div class="progress-stepper" *ngIf="!hasPreselectedService()">
        <div
          class="step"
          [class.active]="currentStep === 1"
          [class.completed]="currentStep > 1"
          (click)="goToStep(1)"
        >
          <div class="step-circle">
            <svg
              *ngIf="currentStep > 1"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <span *ngIf="currentStep <= 1">1</span>
          </div>
          <span class="step-label">Service</span>
        </div>

        <div class="step-line" [class.completed]="currentStep > 1"></div>

        <div
          class="step"
          [class.active]="currentStep === 2"
          [class.completed]="currentStep > 2"
          (click)="goToStep(2)"
        >
          <div class="step-circle">
            <svg
              *ngIf="currentStep > 2"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <span *ngIf="currentStep <= 2">2</span>
          </div>
          <span class="step-label">Date & Time</span>
        </div>

        <div class="step-line" [class.completed]="currentStep > 2"></div>

        <div
          class="step"
          [class.active]="currentStep === 3"
          [class.completed]="currentStep > 3"
          (click)="goToStep(3)"
        >
          <div class="step-circle">
            <svg
              *ngIf="currentStep > 3"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <span *ngIf="currentStep <= 3">3</span>
          </div>
          <span class="step-label">Workshop</span>
        </div>

        <div class="step-line" [class.completed]="currentStep > 3"></div>

        <div class="step" [class.active]="currentStep === 4" [class.completed]="currentStep > 4">
          <div class="step-circle">
            <svg
              *ngIf="currentStep > 4"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <span *ngIf="currentStep <= 4">4</span>
          </div>
          <span class="step-label">Review</span>
        </div>
      </div>
    </div>

    <!-- Step 1: Service Selection -->
    <div class="step-content" *ngIf="currentStep === 1">
      <!-- Preselected Workshop & Service Banner (from workshop-details) -->
      <div class="preselected-banner" *ngIf="preselectedWorkshopName && preselectedServiceName">
        <div class="preselected-icon">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
            <polyline points="22 4 12 14.01 9 11.01" />
          </svg>
        </div>
        <div class="preselected-content">
          <h3>Service Pre-Selected</h3>
          <p class="preselected-workshop">{{ preselectedWorkshopName }}</p>
          <p class="preselected-service">{{ preselectedServiceName }}</p>
          <p class="preselected-price" *ngIf="preselectedMinPrice || preselectedMaxPrice">
            <span *ngIf="preselectedMinPrice && preselectedMaxPrice">
              {{ preselectedMinPrice | number : '1.0-0' }} -
              {{ preselectedMaxPrice | number : '1.0-0' }} EGP
            </span>
            <span *ngIf="preselectedMinPrice && !preselectedMaxPrice">
              From {{ preselectedMinPrice | number : '1.0-0' }} EGP
            </span>
          </p>
        </div>
        <button class="clear-preselection" (click)="clearPreselection()" title="Clear selection">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>

      <div class="section-card">
        <div class="section-header">
          <div class="section-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
            </svg>
          </div>
          <div>
            <h2>Select Your Vehicle</h2>
            <p class="section-subtitle">Choose which vehicle needs service</p>
          </div>
        </div>

        <div class="vehicle-grid" *ngIf="!isLoadingVehicles">
          <div
            class="vehicle-card"
            *ngFor="let vehicle of getFilteredVehicles(); let i = index"
            [class.selected]="selectedVehicle?.id === vehicle.id"
            (click)="selectVehicle(vehicle)"
          >
            <div class="vehicle-check" *ngIf="selectedVehicle?.id === vehicle.id">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="3"
              >
                <polyline points="20 6 9 17 4 12" />
              </svg>
            </div>
            <div class="vehicle-logo">
              <img
                [src]="getCarLogoUrl(vehicle)"
                [alt]="vehicle.make + ' logo'"
                class="car-logo-img"
                (error)="handleLogoError($event)"
              />
            </div>
            <div class="vehicle-info">
              <h3>{{ vehicle.make }} {{ vehicle.model }}</h3>
              <p class="vehicle-details">{{ vehicle.year }} • {{ vehicle.licensePlate }}</p>
            </div>
          </div>
        </div>

        <!-- No matching vehicles for required origin -->
        <div
          class="empty-state origin-mismatch"
          *ngIf="
            !isLoadingVehicles &&
            getFilteredVehicles().length === 0 &&
            userVehicles.length > 0 &&
            preselectedServiceOrigin
          "
        >
          <svg
            width="64"
            height="64"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#f59e0b"
            stroke-width="1.5"
          >
            <path
              d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
            />
            <line x1="12" y1="9" x2="12" y2="13" />
            <line x1="12" y1="17" x2="12.01" y2="17" />
          </svg>
          <h3>No compatible vehicles</h3>
          <p>
            This service is for <strong>{{ preselectedServiceOrigin }}</strong> origin vehicles
            only.
          </p>
          <p class="sub-text">
            You have {{ userVehicles.length }} vehicle(s) but none match the required origin.
          </p>
          <button class="btn-secondary" (click)="clearPreselection()">
            Choose Different Service
          </button>
          <button class="btn-primary" (click)="goToMyVehicles()">Add a Compatible Vehicle</button>
        </div>

        <div class="empty-state" *ngIf="!isLoadingVehicles && userVehicles.length === 0">
          <svg
            width="64"
            height="64"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          <h3>No vehicles found</h3>
          <p>Add a vehicle to your garage to continue</p>
          <button class="btn-primary" (click)="goToMyVehicles()">Go to My Vehicles</button>
        </div>

        <div class="empty-state" *ngIf="isLoadingVehicles">
          <div class="loading-spinner"></div>
          <h3>Loading your vehicles...</h3>
          <p>Please wait while we fetch your saved vehicles</p>
        </div>
      </div>

      <!-- Notes & Photos Section (ONLY show when preselected service from workshop-details) -->
      <div class="section-card" *ngIf="hasPreselectedService() && selectedVehicle">
        <div class="section-header">
          <div class="section-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
            </svg>
          </div>
          <div>
            <h2>Describe Your Issue</h2>
            <p class="section-subtitle">
              Add details and photos to help the workshop understand your needs
            </p>
          </div>
        </div>

        <div class="notes-section preselected-notes">
          <label for="serviceNotesPreselected">Issue Description (optional)</label>
          <textarea
            id="serviceNotesPreselected"
            name="serviceNotesPreselected"
            [(ngModel)]="serviceNotes"
            placeholder="Describe the issue you're experiencing or any specific requests..."
            rows="4"
          ></textarea>

          <!-- Photo Upload Section -->
          <div class="photo-upload-section">
            <label class="upload-label">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
              Upload Photos (optional)
            </label>
            <p class="upload-hint">
              Add photos of the issue to help the workshop understand the problem better
            </p>

            <div
              class="upload-area"
              (click)="triggerFileInput()"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              [class.drag-over]="isDragging"
            >
              <input
                type="file"
                #fileInput
                (change)="onFilesSelected($event)"
                accept="image/*"
                multiple
                hidden
              />
              <div class="upload-content">
                <svg
                  width="32"
                  height="32"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="17 8 12 3 7 8" />
                  <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                <span class="upload-text"
                  >Drag & drop photos here or <span class="upload-link">browse</span></span
                >
                <span class="upload-formats">Supports: JPG, PNG, WEBP (Max 5MB each)</span>
              </div>
            </div>

            <!-- Photo Previews -->
            <div class="photo-previews" *ngIf="selectedPhotos.length > 0">
              <div class="photo-preview" *ngFor="let photo of selectedPhotos; let i = index">
                <img [src]="photo.preview" [alt]="photo.file.name" />
                <button
                  type="button"
                  class="remove-photo"
                  (click)="removePhoto(i)"
                  title="Remove photo"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                  </svg>
                </button>
                <span class="photo-name">{{ photo.file.name }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Service Type Selection (ONLY show when NO preselected service) -->
      <div class="section-card" *ngIf="!hasPreselectedService()">
        <div class="section-header service-type-header">
          <div class="section-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
              />
            </svg>
          </div>
          <div>
            <h2>Choose Service Type</h2>
            <p class="section-subtitle">
              Select the category that best describes your vehicle's needs
            </p>
          </div>
        </div>

        <!-- Categories View -->
        <div *ngIf="!showingSubcategories">
          <!-- Loading State -->
          <div class="empty-state" *ngIf="isLoadingCategories">
            <div class="loading-spinner"></div>
            <h3>Loading service categories...</h3>
            <p>Please wait while we fetch available services</p>
          </div>

          <!-- Error State -->
          <div class="empty-state" *ngIf="!isLoadingCategories && categoriesError">
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="12" y1="8" x2="12" y2="12" />
              <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
            <h3>Unable to load categories</h3>
            <p>{{ categoriesError }}</p>
            <button class="btn-primary" (click)="loadCategories()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="23 4 23 10 17 10" />
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
              </svg>
              Retry
            </button>
          </div>

          <!-- Categories Grid -->
          <div
            class="service-grid"
            #categoriesGrid
            *ngIf="!isLoadingCategories && !categoriesError && categories.length > 0"
          >
            <div
              class="service-card"
              *ngFor="let category of categories"
              (click)="selectCategory(category)"
              [class.has-bg]="getCategoryBgUrl(category)"
              [style.background-image]="
                getCategoryBgUrl(category) ? 'url(' + getCategoryBgUrl(category) + ')' : null
              "
            >
              <div class="service-card-overlay" *ngIf="getCategoryBgUrl(category)"></div>
              <h3>{{ category.name }}</h3>
              <p class="service-description">{{ category.description }}</p>
            </div>
          </div>

          <!-- Empty State -->
          <div
            class="empty-state"
            *ngIf="!isLoadingCategories && !categoriesError && categories.length === 0"
          >
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="15" y1="9" x2="9" y2="15" />
              <line x1="9" y1="9" x2="15" y2="15" />
            </svg>
            <h3>No service categories available</h3>
            <p>Please check back later or contact support</p>
          </div>
        </div>

        <!-- Subcategories View -->
        <div class="subcategories-section" *ngIf="showingSubcategories && selectedCategory">
          <!-- Back Button -->
          <button class="btn-back" (click)="backToCategories()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="15 18 9 12 15 6" />
            </svg>
            Back to Categories
          </button>

          <div class="section-header subcategories-header">
            <div class="section-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 5v14m7-7H5" />
              </svg>
            </div>
            <div>
              <h2>Select {{ selectedCategory.name }}</h2>
              <p class="section-subtitle">Choose the specific service you need</p>
            </div>
          </div>

          <!-- Loading State -->
          <div class="empty-state" *ngIf="isLoadingSubcategories">
            <div class="loading-spinner"></div>
            <h3>Loading service options...</h3>
            <p>Please wait while we fetch available options</p>
          </div>

          <!-- Error State -->
          <div class="empty-state" *ngIf="!isLoadingSubcategories && subcategoriesError">
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="12" y1="8" x2="12" y2="12" />
              <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
            <h3>Unable to load service options</h3>
            <p>{{ subcategoriesError }}</p>
            <button class="btn-primary" (click)="loadSubcategories(selectedCategory!.id)">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="23 4 23 10 17 10" />
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
              </svg>
              Retry
            </button>
          </div>

          <!-- Subcategories Grid -->
          <div
            class="subcategory-grid"
            *ngIf="!isLoadingSubcategories && !subcategoriesError && subcategories.length > 0"
          >
            <div
              class="subcategory-card"
              *ngFor="let subcategory of subcategories"
              [class.selected]="selectedSubcategory?.id === subcategory.id"
              (click)="selectSubcategory(subcategory)"
            >
              <div class="subcategory-check" *ngIf="selectedSubcategory?.id === subcategory.id">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                >
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              </div>
              <div class="subcategory-image-wrapper">
                <img
                  *ngIf="subcategory.imageUrl"
                  [src]="subcategory.imageUrl"
                  [alt]="subcategory.name"
                  class="subcategory-image"
                />
                <div *ngIf="!subcategory.imageUrl" class="subcategory-placeholder">
                  <span>{{ subcategory.icon || '⚙️' }}</span>
                </div>
              </div>
              <h4>{{ subcategory.name }}</h4>
              <p class="subcategory-description">
                {{ subcategory.description || 'Service option' }}
              </p>
            </div>
          </div>

          <!-- Empty State -->
          <div
            class="empty-state"
            *ngIf="!isLoadingSubcategories && !subcategoriesError && subcategories.length === 0"
          >
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="15" y1="9" x2="9" y2="15" />
              <line x1="9" y1="9" x2="15" y2="15" />
            </svg>
            <h3>No service options available</h3>
            <p>Please select a different category or try again later</p>
          </div>
        </div>

        <!-- Services View (appears when subcategory is selected) -->
        <div class="services-section" *ngIf="showingServices && selectedSubcategory">
          <!-- Back Button -->
          <button class="btn-back" (click)="backToSubcategories()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="15 18 9 12 15 6" />
            </svg>
            Back to {{ selectedCategory?.name || 'Subcategories' }}
          </button>

          <div class="section-header services-header">
            <div class="section-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                />
              </svg>
            </div>
            <div>
              <h2>Select Service</h2>
              <p class="section-subtitle">Choose one service from {{ selectedSubcategory.name }}</p>
            </div>
          </div>

          <!-- Loading State -->
          <div class="empty-state" *ngIf="isLoadingServices">
            <div class="loading-spinner"></div>
            <h3>Loading services...</h3>
            <p>Please wait while we fetch available services</p>
          </div>

          <!-- Error State -->
          <div class="empty-state" *ngIf="!isLoadingServices && servicesError">
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="12" y1="8" x2="12" y2="12" />
              <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
            <h3>Unable to load services</h3>
            <p>{{ servicesError }}</p>
            <button class="btn-primary" (click)="loadServices(selectedSubcategory!.id)">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="23 4 23 10 17 10" />
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
              </svg>
              Retry
            </button>
          </div>

          <!-- Services Vertical List -->
          <div
            class="service-selection-list"
            *ngIf="!isLoadingServices && !servicesError && services.length > 0"
          >
            <div
              class="service-selection-item"
              *ngFor="let service of services"
              [class.selected]="selectedService?.id === service.id"
              (click)="selectService(service)"
            >
              <div class="service-selection-radio">
                <input
                  type="radio"
                  [id]="'service-' + service.id"
                  [name]="'service'"
                  [checked]="selectedService?.id === service.id"
                  (change)="selectService(service)"
                />
                <label [for]="'service-' + service.id" class="radio-label"></label>
              </div>
              <div class="service-info">
                <h4>{{ service.name }}</h4>
                <p class="service-selection-description">{{ service.description || 'Service' }}</p>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div
            class="empty-state"
            *ngIf="!isLoadingServices && !servicesError && services.length === 0"
          >
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="15" y1="9" x2="9" y2="15" />
              <line x1="9" y1="9" x2="15" y2="15" />
            </svg>
            <h3>No services available</h3>
            <p>Please select a different option or try again later</p>
          </div>
        </div>

        <!-- Notes Section (show when service is selected manually) -->
        <div class="notes-section" *ngIf="selectedService && !hasPreselectedService()">
          <label for="serviceNotes">Issue Description (optional)</label>
          <textarea
            id="serviceNotes"
            name="serviceNotes"
            [(ngModel)]="serviceNotes"
            #serviceNotesModel="ngModel"
            placeholder="Any specific issues or requests? e.g., Strange noise when braking, AC not cooling properly..."
            rows="3"
          ></textarea>

          <!-- Photo Upload Section -->
          <div class="photo-upload-section">
            <label class="upload-label">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
              Upload Photos (optional)
            </label>
            <p class="upload-hint">
              Add photos of the issue to help the workshop understand the problem better
            </p>

            <div
              class="upload-area"
              (click)="triggerFileInput()"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              [class.drag-over]="isDragging"
            >
              <input
                type="file"
                #fileInput
                (change)="onFilesSelected($event)"
                accept="image/*"
                multiple
                hidden
              />
              <div class="upload-content">
                <svg
                  width="32"
                  height="32"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="17 8 12 3 7 8" />
                  <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                <span class="upload-text"
                  >Drag & drop photos here or <span class="upload-link">browse</span></span
                >
                <span class="upload-formats">Supports: JPG, PNG, WEBP (Max 5MB each)</span>
              </div>
            </div>

            <!-- Photo Previews -->
            <div class="photo-previews" *ngIf="selectedPhotos.length > 0">
              <div class="photo-preview" *ngFor="let photo of selectedPhotos; let i = index">
                <img [src]="photo.preview" [alt]="photo.file.name" />
                <button
                  type="button"
                  class="remove-photo"
                  (click)="removePhoto(i)"
                  title="Remove photo"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                  </svg>
                </button>
                <span class="photo-name">{{ photo.file.name }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="step-actions">
        <button class="btn-secondary" disabled>
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Previous
        </button>
        <button class="btn-primary" [disabled]="!isStep1Valid()" (click)="nextStep()">
          Next
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="9 18 15 12 9 6" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Step 2: Date & Time Selection -->
    <div class="step-content" *ngIf="currentStep === 2">
      <!-- Month Selection -->
      <div class="section-card">
        <div class="section-header">
          <div class="section-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
          </div>
          <div>
            <h2>Select Month</h2>
            <p class="section-subtitle">Choose the month for your service appointment</p>
          </div>
        </div>

        <div class="month-grid">
          <div
            class="month-card"
            *ngFor="let month of availableMonths"
            [class.selected]="isMonthSelected(month.month, month.year)"
            (click)="selectMonth(month.month, month.year)"
          >
            <span class="month-name">{{ month.name }}</span>
            <span class="month-year">{{ month.year }}</span>
          </div>
        </div>
      </div>

      <!-- Day Selection (shown after month selection) -->
      <div class="section-card" *ngIf="selectedMonth !== null && daysInMonth.length > 0">
        <div class="section-header">
          <div class="section-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
          </div>
          <div>
            <h2>Select Day</h2>
            <p class="section-subtitle">{{ MONTH_NAMES[selectedMonth] }} {{ selectedYear }}</p>
          </div>
        </div>

        <div class="calendar-grid">
          <div
            class="date-card"
            *ngFor="let date of daysInMonth"
            [class.selected]="isDateSelectedInMonth(date)"
            (click)="selectDate(date)"
          >
            <span class="date-day">{{ getDayName(date) }}</span>
            <span class="date-number">{{ getDayNumber(date) }}</span>
          </div>
        </div>
      </div>

      <!-- Time Slot Selection (shown after day selection) -->
      <div class="section-card" *ngIf="selectedDate">
        <div class="section-header">
          <div class="section-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
          </div>
          <div>
            <h2>Select Time Slot</h2>
            <p class="section-subtitle">
              {{ formatDateLong(selectedDate) }} - All available time slots
            </p>
          </div>
        </div>

        <div class="timeslot-grid">
          <button
            class="timeslot-btn"
            *ngFor="let slot of availableTimeSlots"
            [class.selected]="selectedTimeSlot === slot"
            [class.unavailable]="!isTimeSlotAvailableWithPast(slot)"
            [disabled]="!isTimeSlotAvailableWithPast(slot)"
            (click)="selectTimeSlot(slot)"
          >
            {{ slot }}
            <span class="unavailable-label" *ngIf="!isTimeSlotAvailableWithPast(slot)">
              {{ !isTimeSlotAvailable(slot) ? 'Booked' : 'Past' }}
            </span>
          </button>
        </div>

        <!-- Timezone Info -->
        <div
          class="timezone-info"
          style="
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f3f4f6;
            border-radius: 8px;
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
          "
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            style="display: inline-block; vertical-align: middle; margin-right: 0.5rem"
          >
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2v20M2 12h20" />
          </svg>
          All times are in Africa/Cairo timezone (UTC+2)
        </div>
      </div>

      <div class="step-actions">
        <button class="btn-secondary" (click)="previousStep()">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Previous
        </button>
        <button class="btn-primary" [disabled]="!isStep2Valid()" (click)="nextStep()">
          Next
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="9 18 15 12 9 6" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Step 3: Workshop Selection (hidden for preselected flow) -->
    <div class="step-content" *ngIf="currentStep === 3 && !hasPreselectedService()">
      <div class="section-card">
        <div class="section-header">
          <div class="section-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
              <circle cx="12" cy="10" r="3" />
            </svg>
          </div>
          <div>
            <h2>Choose Workshop</h2>
            <p class="section-subtitle">
              Select from verified service centers for {{ selectedVehicleOrigin }} vehicles
            </p>
          </div>
        </div>

        <!-- Loading State -->
        <div class="empty-state" *ngIf="isLoadingWorkshops">
          <div class="loading-spinner"></div>
          <h3>Finding workshops...</h3>
          <p>Searching for service centers that match your vehicle and service</p>
        </div>

        <!-- Error State -->
        <div class="empty-state" *ngIf="!isLoadingWorkshops && workshopsError">
          <svg
            width="64"
            height="64"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
          </svg>
          <h3>{{ workshopsError }}</h3>
          <button class="btn-primary" (click)="loadWorkshops()">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="23 4 23 10 17 10" />
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
            </svg>
            Try Again
          </button>
        </div>

        <!-- Workshop List -->
        <div
          class="workshop-list"
          *ngIf="!isLoadingWorkshops && !workshopsError && workshops.length > 0"
        >
          <!-- Pagination Info -->
          <div class="pagination-info" *ngIf="workshopTotalPages > 1">
            <span class="results-count">
              Showing {{ workshops.length }} of {{ workshopTotalRecords }} workshops
            </span>
            <span class="page-indicator">
              Page {{ workshopCurrentPage }} of {{ workshopTotalPages }}
            </span>
          </div>

          <div
            class="workshop-card"
            *ngFor="let workshop of workshops"
            [class.selected]="isWorkshopSelected(workshop)"
            [class.workshop-closed]="workshop.isClosed"
            (click)="toggleWorkshop(workshop)"
          >
            <!-- Selection Indicator -->
            <div class="card-selection" *ngIf="isWorkshopSelected(workshop)">
              <div class="selection-badge">
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                >
                  <polyline points="20 6 9 17 4 12" />
                </svg>
                SELECTED
              </div>
            </div>

            <!-- Status Badge (Top Right) -->
            <div
              class="status-tag"
              [class.open]="!workshop.isClosed"
              [class.closed]="workshop.isClosed"
            >
              <span class="status-dot"></span>
              {{ workshop.isClosed ? 'Closed' : 'Open Now' }}
              <span class="working-hours-hint" *ngIf="workshop.isClosed"
                >• Check working hours</span
              >
            </div>

            <!-- Main Content -->
            <div class="card-body">
              <!-- Left: Logo -->
              <div class="logo-wrapper">
                <div class="workshop-logo">
                  <img
                    *ngIf="getWorkshopLogoUrl(workshop)"
                    [src]="getWorkshopLogoUrl(workshop)"
                    [alt]="workshop.name"
                    (error)="$any($event.target).style.display = 'none'"
                  />
                  <div *ngIf="!getWorkshopLogoUrl(workshop)" class="logo-placeholder-icon">
                    <svg
                      width="32"
                      height="32"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                    >
                      <path
                        d="M19 21V5a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5m-4 0h4"
                      />
                    </svg>
                  </div>
                </div>
                <div class="rating-badge">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="#FCD34D">
                    <path
                      d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                    />
                  </svg>
                  <span>{{ workshop.rating | number : '1.1-1' }}</span>
                </div>
              </div>

              <!-- Center: Info -->
              <div class="workshop-info">
                <div class="info-header">
                  <h3 class="workshop-name">{{ workshop.name }}</h3>
                  <span class="workshop-type" *ngIf="workshop.workshopType">{{
                    workshop.workshopType
                  }}</span>
                </div>

                <p class="workshop-desc" *ngIf="workshop.workshopDescription">
                  {{
                    workshop.workshopDescription.length > 80
                      ? (workshop.workshopDescription | slice : 0 : 80) + '...'
                      : workshop.workshopDescription
                  }}
                </p>

                <!-- Service Badge -->
                <div class="service-badge" *ngIf="workshop.serviceName">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                    />
                  </svg>
                  <span>{{ workshop.serviceName }}</span>
                </div>

                <!-- Quick Info -->
                <div class="quick-info">
                  <button
                    class="location-btn"
                    *ngIf="workshop.city || workshop.address"
                    (click)="openInGoogleMaps(workshop, $event)"
                    title="Open in Google Maps"
                  >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                      <circle cx="12" cy="10" r="3" />
                    </svg>
                    {{ workshop.city || workshop.address }}
                    <svg
                      width="10"
                      height="10"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      class="external-icon"
                    >
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                      <polyline points="15 3 21 3 21 9" />
                      <line x1="10" y1="14" x2="21" y2="3" />
                    </svg>
                  </button>
                  <span class="info-chip" *ngIf="workshop.duration">
                    <svg
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <circle cx="12" cy="12" r="10" />
                      <polyline points="12 6 12 12 16 14" />
                    </svg>
                    {{ workshop.duration }} min
                  </span>
                  <span class="info-chip" *ngIf="workshop.reviewCount">
                    <svg
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                    {{ workshop.reviewCount }} reviews
                  </span>
                </div>
              </div>

              <!-- Right: Price -->
              <div class="card-actions">
                <div
                  class="price-tag"
                  *ngIf="workshop.minPrice || workshop.maxPrice || workshop.price"
                >
                  <span class="price-amount">
                    <ng-container
                      *ngIf="
                        workshop.minPrice &&
                        workshop.maxPrice &&
                        workshop.minPrice !== workshop.maxPrice
                      "
                    >
                      {{ workshop.minPrice | number : '1.0-0' }}-{{
                        workshop.maxPrice | number : '1.0-0'
                      }}
                    </ng-container>
                    <ng-container
                      *ngIf="
                        workshop.price &&
                        (!workshop.minPrice || workshop.minPrice === workshop.maxPrice)
                      "
                    >
                      {{ workshop.price | number : '1.0-0' }}
                    </ng-container>
                    <ng-container
                      *ngIf="
                        !workshop.price &&
                        workshop.minPrice &&
                        (!workshop.maxPrice || workshop.minPrice === workshop.maxPrice)
                      "
                    >
                      {{ workshop.minPrice | number : '1.0-0' }}
                    </ng-container>
                  </span>
                  <span class="price-currency">EGP</span>
                </div>
              </div>
            </div>

            <!-- View Button - Bottom Right -->
            <a
              [routerLink]="['/workshop-details', workshop.workshopProfileId || workshop.id]"
              target="_blank"
              class="view-btn"
              (click)="$event.stopPropagation()"
            >
              View Workshop Details
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
              >
                <path d="M7 17L17 7M17 7H7M17 7V17" />
              </svg>
            </a>
          </div>

          <!-- Pagination Wrapper -->
          <div class="pagination-wrapper" *ngIf="!isLoadingWorkshops && workshops.length > 0">
            <div class="pagination-container">
              <!-- Results Summary -->
              <div class="pagination-info">
                <span class="showing-text">
                  Showing <strong>{{ getWorkshopStartRecord() }}</strong> -
                  <strong>{{ getWorkshopEndRecord() }}</strong> of
                  <strong>{{ workshopTotalRecords }}</strong> workshops
                </span>
              </div>

              <!-- Page Navigation -->
              <div class="pagination-nav" *ngIf="workshopTotalPages > 1">
                <!-- First Page -->
                <button
                  class="pagination-btn nav-btn"
                  [disabled]="workshopCurrentPage === 1"
                  (click)="goToWorkshopPage(1)"
                  title="First Page"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="11 17 6 12 11 7" />
                    <polyline points="18 17 13 12 18 7" />
                  </svg>
                </button>

                <!-- Previous Page -->
                <button
                  class="pagination-btn nav-btn"
                  [disabled]="!workshopHasPreviousPage"
                  (click)="previousWorkshopPage()"
                  title="Previous Page"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M15 18l-6-6 6-6" />
                  </svg>
                </button>

                <!-- Page Numbers -->
                <div class="pagination-pages">
                  <!-- First page always shown -->
                  <button
                    class="page-btn"
                    [class.active]="workshopCurrentPage === 1"
                    (click)="goToWorkshopPage(1)"
                  >
                    1
                  </button>

                  <!-- Left ellipsis -->
                  <span class="page-ellipsis" *ngIf="workshopCurrentPage > 3">...</span>

                  <!-- Pages around current -->
                  <ng-container *ngFor="let page of getWorkshopVisiblePages()">
                    <button
                      *ngIf="page !== 1 && page !== workshopTotalPages"
                      class="page-btn"
                      [class.active]="workshopCurrentPage === page"
                      (click)="goToWorkshopPage(page)"
                    >
                      {{ page }}
                    </button>
                  </ng-container>

                  <!-- Right ellipsis -->
                  <span class="page-ellipsis" *ngIf="workshopCurrentPage < workshopTotalPages - 2"
                    >...</span
                  >

                  <!-- Last page always shown -->
                  <button
                    *ngIf="workshopTotalPages > 1"
                    class="page-btn"
                    [class.active]="workshopCurrentPage === workshopTotalPages"
                    (click)="goToWorkshopPage(workshopTotalPages)"
                  >
                    {{ workshopTotalPages }}
                  </button>
                </div>

                <!-- Next Page -->
                <button
                  class="pagination-btn nav-btn"
                  [disabled]="!workshopHasNextPage"
                  (click)="nextWorkshopPage()"
                  title="Next Page"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M9 18l6-6-6-6" />
                  </svg>
                </button>

                <!-- Last Page -->
                <button
                  class="pagination-btn nav-btn"
                  [disabled]="workshopCurrentPage === workshopTotalPages"
                  (click)="goToWorkshopPage(workshopTotalPages)"
                  title="Last Page"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="13 17 18 12 13 7" />
                    <polyline points="6 17 11 12 6 7" />
                  </svg>
                </button>
              </div>

              <!-- Page Size Selector -->
              <div class="page-size-selector">
                <label>Per page:</label>
                <select [(ngModel)]="workshopPageSize" (ngModelChange)="onWorkshopPageSizeChange()">
                  <option [value]="3">3</option>
                  <option [value]="6">6</option>
                  <option [value]="9">9</option>
                  <option [value]="15">15</option>
                  <option [value]="30">30</option>
                  <option [value]="60">60</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State (no workshops found) -->
        <div
          class="empty-state"
          *ngIf="!isLoadingWorkshops && !workshopsError && workshops.length === 0"
        >
          <svg
            width="64"
            height="64"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
            <circle cx="12" cy="10" r="3" />
          </svg>
          <h3>No workshops available</h3>
          <p>
            No service centers found for {{ selectedService?.name || 'this service' }} with
            {{ selectedVehicleOrigin }} vehicles. Try selecting a different service.
          </p>
        </div>
      </div>

      <div class="step-actions">
        <button class="btn-secondary" (click)="previousStep()">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Previous
        </button>
        <button class="btn-primary" [disabled]="!isStep3Valid()" (click)="nextStep()">
          Next
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="9 18 15 12 9 6" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Step 4: Review & Confirm (Step 3 for preselected flow) -->
    <div
      class="step-content"
      *ngIf="
        (hasPreselectedService() && currentStep === 3) ||
        (!hasPreselectedService() && currentStep === 4)
      "
    >
      <div class="section-card">
        <div class="section-header">
          <div class="section-icon">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 11l3 3L22 4" />
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
            </svg>
          </div>
          <div>
            <h2>Review Your Booking</h2>
            <p class="section-subtitle">Please verify all details before confirming</p>
          </div>
        </div>

        <div class="review-section">
          <div class="review-item">
            <div class="review-label">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
              </svg>
              <span>Vehicle</span>
            </div>
            <div class="review-value">
              <strong>{{ selectedVehicle?.make }} {{ selectedVehicle?.model }}</strong>
              <span class="review-subtext"
                >{{ selectedVehicle?.year }} • {{ selectedVehicle?.licensePlate }}</span
              >
            </div>
            <button class="review-edit" (click)="goToStep(1)">Edit</button>
          </div>

          <div class="review-item">
            <div class="review-label">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                />
              </svg>
              <span>Service</span>
            </div>
            <div class="review-value">
              <!-- Show preselected service name or selected category -->
              <strong>{{
                hasPreselectedService() ? preselectedServiceName : selectedCategory?.name
              }}</strong>
              <span class="review-subtext" *ngIf="!hasPreselectedService()">{{
                selectedCategory?.description
              }}</span>
              <span
                class="review-subtext"
                *ngIf="hasPreselectedService() && (preselectedMinPrice || preselectedMaxPrice)"
              >
                <ng-container *ngIf="preselectedMinPrice && preselectedMaxPrice">
                  {{ preselectedMinPrice | number : '1.0-0' }} -
                  {{ preselectedMaxPrice | number : '1.0-0' }} EGP
                </ng-container>
                <ng-container *ngIf="preselectedMinPrice && !preselectedMaxPrice">
                  From {{ preselectedMinPrice | number : '1.0-0' }} EGP
                </ng-container>
              </span>
              <span class="review-notes" *ngIf="serviceNotes">Note: {{ serviceNotes }}</span>
              <!-- Photo previews in review -->
              <div class="review-photos" *ngIf="selectedPhotos.length > 0">
                <span class="review-photos-label"
                  >Photos: {{ selectedPhotos.length }} attached</span
                >
                <div class="review-photo-grid">
                  <div class="review-photo-thumb" *ngFor="let photo of selectedPhotos">
                    <img [src]="photo.preview" [alt]="photo.file.name" />
                  </div>
                </div>
              </div>
            </div>
            <button class="review-edit" (click)="goToStep(1)">Edit</button>
          </div>

          <div class="review-item">
            <div class="review-label">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
              </svg>
              <span>Date & Time</span>
            </div>
            <div class="review-value">
              <strong>{{ formatDateLong(selectedDate!) }}</strong>
              <span class="review-subtext">{{ selectedTimeSlot }}</span>
            </div>
            <button class="review-edit" (click)="goToStep(2)">Edit</button>
          </div>

          <div class="review-item">
            <div class="review-label">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                <circle cx="12" cy="10" r="3" />
              </svg>
              <span>Workshop</span>
            </div>
            <div class="review-value" *ngIf="selectedWorkshop">
              <strong>{{ selectedWorkshop.name }}</strong>
              <span class="review-subtext">{{
                selectedWorkshop.city || selectedWorkshop.address
              }}</span>
              <span class="review-subtext" *ngIf="selectedWorkshop.price"
                >{{ selectedWorkshop.price | number : '1.0-0' }} EGP</span
              >
            </div>
            <!-- Hide edit button for preselected workshop -->
            <button class="review-edit" *ngIf="!hasPreselectedService()" (click)="goToStep(3)">
              Edit
            </button>
          </div>

          <div class="review-item" *ngIf="selectedPaymentMethod">
            <div class="review-label">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
                <line x1="1" y1="10" x2="23" y2="10" />
              </svg>
              <span>Payment</span>
            </div>
            <div class="review-value">
              <strong>{{ selectedPaymentMethod === 'cash' ? 'Cash' : 'Credit Card' }}</strong>
              <span class="review-subtext">{{
                selectedPaymentMethod === 'cash'
                  ? 'Pay at workshop after service'
                  : 'Secure card payment'
              }}</span>
            </div>
            <button class="review-edit" (click)="goToStep(3)">Edit</button>
          </div>
        </div>

        <div class="price-breakdown">
          <h3>Price Estimate</h3>
          <div class="price-item">
            <span>Service Category</span>
            <span>{{ selectedCategory?.name }}</span>
          </div>
          <div class="price-item" *ngIf="selectedWorkshop?.minPrice || selectedWorkshop?.maxPrice">
            <span>Estimated Price</span>
            <span class="price-range">
              <ng-container *ngIf="selectedWorkshop?.minPrice && selectedWorkshop?.maxPrice">
                {{ selectedWorkshop!.minPrice | number : '1.0-0' }} -
                {{ selectedWorkshop!.maxPrice | number : '1.0-0' }} EGP
              </ng-container>
              <ng-container *ngIf="selectedWorkshop?.minPrice && !selectedWorkshop?.maxPrice">
                From {{ selectedWorkshop!.minPrice | number : '1.0-0' }} EGP
              </ng-container>
              <ng-container *ngIf="!selectedWorkshop?.minPrice && selectedWorkshop?.maxPrice">
                Up to {{ selectedWorkshop!.maxPrice | number : '1.0-0' }} EGP
              </ng-container>
            </span>
          </div>
          <div class="price-divider"></div>
          <p
            class="price-note"
            *ngIf="!selectedWorkshop?.minPrice && !selectedWorkshop?.maxPrice"
            style="margin-top: 1rem; text-align: center"
          >
            *Price will be determined after service selection and workshop inspection
          </p>
          <p
            class="price-note"
            *ngIf="selectedWorkshop?.minPrice || selectedWorkshop?.maxPrice"
            style="margin-top: 1rem; text-align: center"
          >
            *Final price may vary based on vehicle condition and parts required
          </p>
        </div>
      </div>

      <div class="step-actions">
        <button class="btn-secondary" (click)="previousStep()">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Previous
        </button>
        <button
          type="button"
          class="btn-primary btn-confirm"
          [disabled]="isSubmittingBooking"
          (click)="confirmBooking()"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="20 6 9 17 4 12" />
          </svg>
          <span *ngIf="!isSubmittingBooking">Confirm Booking</span>
          <span *ngIf="isSubmittingBooking">Confirming...</span>
        </button>
      </div>
    </div>

    <!-- Step 5: Success -->
    <div class="success-content" *ngIf="currentStep === 5">
      <div class="success-animation">
        <div class="success-circle">
          <svg
            width="64"
            height="64"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="20 6 9 17 4 12" />
          </svg>
        </div>
      </div>

      <h1 class="success-title">Booking Confirmed!</h1>
      <p class="success-subtitle">Your service has been successfully scheduled</p>

      <div class="confirmation-card">
        <div class="confirmation-number">
          <span class="label">Confirmation Number</span>
          <span class="number">{{ confirmationNumber }}</span>
        </div>

        <div class="confirmation-details">
          <div class="confirmation-item">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
            </svg>
            <div>
              <strong>{{ selectedVehicle?.make }} {{ selectedVehicle?.model }}</strong>
              <span>{{ selectedVehicle?.licensePlate }}</span>
            </div>
          </div>

          <div class="confirmation-item">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
            <div>
              <strong>{{ formatDateLong(selectedDate!) }}</strong>
              <span>{{ selectedTimeSlot }}</span>
            </div>
          </div>

          <div class="confirmation-item">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
              <circle cx="12" cy="10" r="3" />
            </svg>
            <div *ngIf="selectedWorkshop">
              <strong>{{ selectedWorkshop.name }}</strong>
              <span>{{ selectedWorkshop.city || selectedWorkshop.address }}</span>
              <span *ngIf="selectedWorkshop.price">
                - {{ selectedWorkshop.price | number : '1.0-0' }} EGP</span
              >
            </div>
          </div>
        </div>

        <div class="confirmation-info">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="16" x2="12" y2="12" />
            <line x1="12" y1="8" x2="12.01" y2="8" />
          </svg>
          <p>
            A confirmation email has been sent to your registered email address. Please arrive 10
            minutes early.
          </p>
        </div>
      </div>

      <div class="success-actions">
        <button class="btn-primary" (click)="goToMyVehicles()">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
          </svg>
          Go to My Vehicles
        </button>
        <button class="btn-secondary" (click)="startNewBooking()">Book Another Service</button>
      </div>
    </div>
  </div>

  <!-- Payment Method Popup -->
  <app-payment-method-popup
    *ngIf="showPaymentPopup"
    (paymentMethodSelected)="onPaymentMethodSelected($event)"
    (closePopup)="closePaymentPopup()"
  >
  </app-payment-method-popup>
</div>
