<div class="job-detail-page" *ngIf="job">
  <!-- Page Header -->
  <div class="page-header">
    <button class="back-btn" (click)="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Job Board
    </button>
    
    <div class="header-actions">
      <button class="action-btn secondary">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        Edit Job
      </button>
      <button class="action-btn primary" (click)="toggleUpsellForm()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Suggest Additional Repair
      </button>
    </div>
  </div>

  <!-- Job Card -->
  <div class="job-card-container">
    <!-- Left Column - Main Info -->
    <div class="left-column">
      <!-- Car Header -->
      <div class="card car-header-card">
        <div class="car-header">
          <div class="car-image-wrapper">
            <img [src]="job.vehicle.imageUrl || 'assets/images/default-car.jpg'" [alt]="job.vehicle.make + ' ' + job.vehicle.model" class="car-image">
          </div>
          <div class="car-info">
            <h2 class="car-title">{{ job.vehicle.year }} {{ job.vehicle.make }} {{ job.vehicle.model }}</h2>
            <div class="car-details-grid">
              <div class="detail-item">
                <span class="label">Plate Number:</span>
                <span class="value">{{ job.vehicle.plateNumber }}</span>
              </div>
              <div class="detail-item">
                <span class="label">VIN:</span>
                <span class="value">{{ job.vehicle.vin }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Color:</span>
                <span class="value">{{ job.vehicle.color || 'Not specified' }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Mileage:</span>
                <span class="value">{{ job.vehicle.mileage || 'Not specified' }} km</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Customer & Complaint -->
      <div class="card customer-card">
        <div class="card-header">
          <h3 class="card-title">Customer Information</h3>
          <span class="urgency-badge" [ngClass]="'urgency-' + job.urgency">
            {{ job.urgency.toUpperCase() }}
          </span>
        </div>
        <div class="customer-info-grid">
          <img [src]="job.customer.avatar" [alt]="job.customer.name" class="customer-avatar-large">
          <div class="customer-details">
            <h4 class="customer-name">{{ job.customer.name }}</h4>
            <div class="contact-info">
              <a [href]="'tel:' + job.customer.phone" class="contact-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
                {{ job.customer.phone }}
              </a>
              <a [href]="'mailto:' + job.customer.email" class="contact-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <polyline points="22,6 12,13 2,6"/>
                </svg>
                {{ job.customer.email }}
              </a>
            </div>
          </div>
        </div>
        
        <div class="complaint-section">
          <h4 class="section-title">Customer Complaint</h4>
          <p class="complaint-text">{{ job.customerComplaint }}</p>
        </div>
        
        <div class="requested-services">
          <h4 class="section-title">Requested Services</h4>
          <div class="service-tags">
            <span class="service-tag" *ngFor="let service of job.requestedServices">{{ service }}</span>
          </div>
        </div>
      </div>

      <!-- Service Stage Tracker -->
      <div class="card stage-tracker-card">
        <div class="card-header">
          <h3 class="card-title">Service Progress</h3>
          <span class="progress-percentage">{{ getStageProgress() }}%</span>
        </div>
        
        <div class="stage-tracker">
          <div class="stage-item" [class.active]="job.stage === 'received'" [class.completed]="['diagnosing', 'repairing', 'testing', 'done'].includes(job.stage)">
            <div class="stage-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
            </div>
            <div class="stage-content">
              <span class="stage-label">Received</span>
              <button class="stage-btn" (click)="updateStage('received')" *ngIf="job.stage !== 'received'">Set</button>
            </div>
          </div>
          
          <div class="stage-connector" [class.active]="['diagnosing', 'repairing', 'testing', 'done'].includes(job.stage)"></div>
          
          <div class="stage-item" [class.active]="job.stage === 'diagnosing'" [class.completed]="['repairing', 'testing', 'done'].includes(job.stage)">
            <div class="stage-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
            </div>
            <div class="stage-content">
              <span class="stage-label">Diagnosing</span>
              <button class="stage-btn" (click)="updateStage('diagnosing')" *ngIf="job.stage !== 'diagnosing'">Set</button>
            </div>
          </div>
          
          <div class="stage-connector" [class.active]="['repairing', 'testing', 'done'].includes(job.stage)"></div>
          
          <div class="stage-item" [class.active]="job.stage === 'repairing'" [class.completed]="['testing', 'done'].includes(job.stage)">
            <div class="stage-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
              </svg>
            </div>
            <div class="stage-content">
              <span class="stage-label">Repairing</span>
              <button class="stage-btn" (click)="updateStage('repairing')" *ngIf="job.stage !== 'repairing'">Set</button>
            </div>
          </div>
          
          <div class="stage-connector" [class.active]="['testing', 'done'].includes(job.stage)"></div>
          
          <div class="stage-item" [class.active]="job.stage === 'testing'" [class.completed]="job.stage === 'done'">
            <div class="stage-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"/>
                <path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z"/>
              </svg>
            </div>
            <div class="stage-content">
              <span class="stage-label">Testing</span>
              <button class="stage-btn" (click)="updateStage('testing')" *ngIf="job.stage !== 'testing'">Set</button>
            </div>
          </div>
          
          <div class="stage-connector" [class.active]="job.stage === 'done'"></div>
          
          <div class="stage-item" [class.active]="job.stage === 'done'">
            <div class="stage-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </div>
            <div class="stage-content">
              <span class="stage-label">Done</span>
              <button class="stage-btn" (click)="updateStage('done')" *ngIf="job.stage !== 'done'">Set</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs-container">
        <div class="tabs">
          <button class="tab" [class.active]="activeTab === 'overview'" (click)="switchTab('overview')">Overview</button>
          <button class="tab" [class.active]="activeTab === 'quote'" (click)="switchTab('quote')">Quote Builder</button>
          <button class="tab" [class.active]="activeTab === 'chat'" (click)="switchTab('chat')">Chat</button>
          <button class="tab" [class.active]="activeTab === 'media'" (click)="switchTab('media')">Media</button>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Overview Tab -->
          <div *ngIf="activeTab === 'overview'" class="overview-content">
            <div class="timeline-item">
              <strong>Scheduled:</strong> {{ formatDate(job.scheduledDate) }}
            </div>
            <div class="timeline-item" *ngIf="job.dropoffDate">
              <strong>Dropped Off:</strong> {{ formatDate(job.dropoffDate) }}
            </div>
            <div class="timeline-item" *ngIf="job.estimatedCompletionDate">
              <strong>Estimated Completion:</strong> {{ formatDate(job.estimatedCompletionDate) }}
            </div>
            <div class="timeline-item" *ngIf="job.assignedTechnicianName">
              <strong>Assigned To:</strong> {{ job.assignedTechnicianName }}
            </div>
          </div>

          <!-- Quote Builder Tab -->
          <div *ngIf="activeTab === 'quote'" class="quote-content">
            <div class="quote-builder">
              <h4>Services</h4>
              <div class="add-item-form">
                <input [(ngModel)]="newService.name" placeholder="Service name" class="form-input">
                <input [(ngModel)]="newService.description" placeholder="Description" class="form-input">
                <input type="number" [(ngModel)]="newService.price" placeholder="Price" class="form-input">
                <button (click)="addService()" class="btn-add">Add Service</button>
              </div>
              
              <div class="items-list">
                <div class="item-row" *ngFor="let service of quoteForm.services; let i = index">
                  <span>{{ service.name }}</span>
                  <span>{{ formatCurrency(service.total) }}</span>
                  <button (click)="removeService(i)" class="btn-remove">Remove</button>
                </div>
              </div>

              <h4>Parts</h4>
              <div class="add-item-form">
                <input [(ngModel)]="newPart.name" placeholder="Part name" class="form-input">
                <input type="number" [(ngModel)]="newPart.price" placeholder="Price" class="form-input">
                <button (click)="addPart()" class="btn-add">Add Part</button>
              </div>
              
              <div class="items-list">
                <div class="item-row" *ngFor="let part of quoteForm.parts; let i = index">
                  <span>{{ part.name }}</span>
                  <span>{{ formatCurrency(part.total) }}</span>
                  <button (click)="removePart(i)" class="btn-remove">Remove</button>
                </div>
              </div>

              <div class="quote-summary">
                <div class="summary-row">
                  <span>Subtotal:</span>
                  <span>{{ formatCurrency(getQuoteSubtotal()) }}</span>
                </div>
                <div class="summary-row">
                  <span>Tax (15%):</span>
                  <span>{{ formatCurrency(getQuoteTax()) }}</span>
                </div>
                <div class="summary-row total">
                  <span>Total:</span>
                  <span>{{ formatCurrency(getQuoteTotal()) }}</span>
                </div>
              </div>

              <button (click)="saveAndSendQuote()" class="btn-send-quote">Save & Send Quote</button>
            </div>
          </div>

          <!-- Chat Tab -->
          <div *ngIf="activeTab === 'chat'" class="chat-content">
            <div class="messages-list">
              <div class="message" *ngFor="let msg of job.chatMessages" [class.workshop]="msg.senderType === 'workshop'">
                <div class="message-header">
                  <strong>{{ msg.senderName }}</strong>
                  <span class="timestamp">{{ formatDate(msg.timestamp) }}</span>
                </div>
                <p>{{ msg.message }}</p>
              </div>
            </div>
            <div class="message-input">
              <input [(ngModel)]="newMessage" placeholder="Type a message..." class="form-input" (keyup.enter)="sendMessage()">
              <button (click)="sendMessage()" class="btn-send">Send</button>
            </div>
          </div>

          <!-- Media Tab -->
          <div *ngIf="activeTab === 'media'" class="media-content">
            <div class="upload-area">
              <input type="file" (change)="onFileSelected($event)" accept="image/*,video/*" #fileInput style="display:none">
              <button (click)="fileInput.click()" class="btn-upload">Upload Photo/Video</button>
            </div>
            <div class="media-grid">
              <div class="media-item" *ngFor="let media of job.media">
                <img *ngIf="media.type === 'image'" [src]="media.url" [alt]="media.caption">
                <video *ngIf="media.type === 'video'" [src]="media.url" controls></video>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Sidebar -->
    <div class="right-column">
      <!-- Additional Repairs -->
      <div class="card" *ngIf="job.additionalRepairs.length > 0">
        <h3 class="card-title">Additional Repairs</h3>
        <div class="additional-repairs-list">
          <div class="repair-item" *ngFor="let repair of job.additionalRepairs">
            <h4>{{ repair.title }}</h4>
            <p>{{ repair.description }}</p>
            <span class="repair-cost">{{ formatCurrency(repair.estimatedCost) }}</span>
            <span class="repair-status" [ngClass]="repair.status">{{ repair.status }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upsell Form Modal -->
  <div class="modal-overlay" *ngIf="showUpsellForm" (click)="toggleUpsellForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Suggest Additional Repair</h3>
      <div class="form-group">
        <label>Title</label>
        <input [(ngModel)]="upsellForm.title" placeholder="E.g., Replace worn brake rotors" class="form-input">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea [(ngModel)]="upsellForm.description" placeholder="Explain the issue..." class="form-textarea"></textarea>
      </div>
      <div class="form-group">
        <label>Estimated Cost</label>
        <input type="number" [(ngModel)]="upsellForm.estimatedCost" placeholder="0" class="form-input">
      </div>
      <div class="form-actions">
        <button (click)="toggleUpsellForm()" class="btn-cancel">Cancel</button>
        <button (click)="submitAdditionalRepair()" class="btn-submit">Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="empty-state" *ngIf="!job">
  <p>Loading job details...</p>
</div>
