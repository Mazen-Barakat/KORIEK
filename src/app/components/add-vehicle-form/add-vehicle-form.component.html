<div class="form-container">
  <button class="close-btn" type="button" (click)="onClose()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <line x1="18" y1="6" x2="6" y2="18"/>
      <line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  </button>

  <div class="form-header">
    <div class="header-icon">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 17h14v-5l-1.5-4.5h-11L5 12v5z"/>
        <circle cx="7.5" cy="17.5" r="1.5"/>
        <circle cx="16.5" cy="17.5" r="1.5"/>
      </svg>
    </div>
    <h2>Add New Vehicle</h2>
    <p>Complete the details below to add your car</p>
  </div>

  <!-- Result Message Display -->
  <div *ngIf="showMessage" class="message-banner" [class.success]="isSuccess" [class.error]="!isSuccess">
    <div class="message-icon-wrapper">
      <svg *ngIf="isSuccess" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <svg *ngIf="!isSuccess" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
    </div>
    <p class="message-text">{{ resultMessage }}</p>
    <button type="button" class="message-dismiss" (click)="dismissMessage()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>

  <form [formGroup]="addVehicleForm" (ngSubmit)="onSubmit()">
    <!-- Section: Vehicle Information -->
    <div class="form-section">
      <div class="section-label">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="16" x2="12" y2="12"/>
          <line x1="12" y1="8" x2="12.01" y2="8"/>
        </svg>
        <span>Vehicle Information</span>
      </div>

      <!-- Row 1: Make and Model -->
      <div class="form-row">
        <div class="form-group combobox">
          <label for="make">Make <span class="required">*</span></label>
          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 17h14v-5l-1.5-4.5h-11L5 12v5z"/>
              <circle cx="7.5" cy="17.5" r="1.5"/>
              <circle cx="16.5" cy="17.5" r="1.5"/>
            </svg>
            <input id="make" type="text" formControlName="make" placeholder="e.g., Toyota, BMW"
              (input)="onComboInput('make',$event)" (focus)="onComboFocus('make')" (blur)="onComboBlur('make')" (keydown)="onComboKeyDown($event,'make')">
          </div>

          <div *ngIf="showMakeList && filteredMakes.length" class="combo-list">
            <div *ngFor="let opt of filteredMakes; let i = index"
                 class="combo-item"
                 [class.highlight]="i === highlightedMakeIndex"
                 (mousedown)="selectComboSuggestion('make', opt)">
              {{ opt }}
            </div>
          </div>

          <div class="error-message" *ngIf="addVehicleForm.get('make')?.invalid && (addVehicleForm.get('make')?.dirty || addVehicleForm.get('make')?.touched)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span *ngIf="addVehicleForm.get('make')?.errors?.['required']">Make is required</span>
          </div>
        </div>
        
        <div class="form-group combobox">
          <label for="model">Model <span class="required">*</span></label>
          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <path d="M9 3v18"/>
              <path d="M15 3v18"/>
            </svg>
            <input id="model" type="text" formControlName="model" placeholder="e.g., Camry, X5"
              [disabled]="!modelsForSelectedMake.length"
              (input)="onComboInput('model',$event)" (focus)="onComboFocus('model')" (blur)="onComboBlur('model')" (keydown)="onComboKeyDown($event,'model')">
          </div>

          <div *ngIf="showModelList && filteredModels.length" class="combo-list">
            <div *ngFor="let opt of filteredModels; let i = index"
                 class="combo-item"
                 [class.highlight]="i === highlightedModelIndex"
                 (mousedown)="selectComboSuggestion('model', opt)">
              {{ opt }}
            </div>
          </div>

          <div class="error-message" *ngIf="addVehicleForm.get('model')?.invalid && (addVehicleForm.get('model')?.dirty || addVehicleForm.get('model')?.touched)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span *ngIf="addVehicleForm.get('model')?.errors?.['required']">Model is required</span>
          </div>
        </div>
      </div>

      <!-- Row 2: Year and Engine Capacity -->
      <div class="form-row">
        <div class="form-group combobox">
          <label for="year">Year <span class="required">*</span></label>
          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <input id="year" type="text" formControlName="year" placeholder="e.g., 2024"
              (input)="onComboInput('year',$event)" (focus)="onComboFocus('year')" (blur)="onComboBlur('year')" (keydown)="onComboKeyDown($event,'year')">
          </div>

          <div *ngIf="showYearList && filteredYears.length" class="combo-list">
            <div *ngFor="let opt of filteredYears; let i = index"
                 class="combo-item"
                 [class.highlight]="i === highlightedYearIndex"
                 (mousedown)="selectComboSuggestion('year', opt)">
              {{ opt }}
            </div>
          </div>

          <div class="error-message" *ngIf="addVehicleForm.get('year')?.invalid && (addVehicleForm.get('year')?.dirty || addVehicleForm.get('year')?.touched)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span *ngIf="addVehicleForm.get('year')?.errors?.['required']">Year is required</span>
          </div>
        </div>
        
        <div class="form-group combobox">
          <label for="engineCapacity">Engine Capacity <span class="required">*</span></label>
          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v20"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            <input id="engineCapacity" type="text" formControlName="engineCapacity" placeholder="e.g., 1500 CC"
              (input)="onEngineInput($event)" (focus)="onEngineFocus()" (blur)="onEngineBlur()" (keydown)="onEngineKeyDown($event)">
          </div>

          <div *ngIf="showEngineList && filteredEngineCapacities.length" class="combo-list">
            <div *ngFor="let opt of filteredEngineCapacities; let i = index"
                 class="combo-item"
                 [class.highlight]="i === highlightedIndex"
                 (mousedown)="selectEngineSuggestion(opt)">
              {{ opt }}
            </div>
          </div>

          <div class="error-message" *ngIf="addVehicleForm.get('engineCapacity')?.invalid && (addVehicleForm.get('engineCapacity')?.dirty || addVehicleForm.get('engineCapacity')?.touched)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span *ngIf="addVehicleForm.get('engineCapacity')?.errors?.['required']">Engine capacity is required</span>
            <span *ngIf="addVehicleForm.get('engineCapacity')?.errors?.['engineInvalid']">Must be greater than 0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Section: Specifications -->
    <div class="form-section">
      <div class="section-label">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        <span>Specifications</span>
      </div>

      <!-- Row 3: Transmission Type and Fuel Type -->
      <div class="form-row">
        <div class="form-group combobox">
          <label for="transmissionType">Transmission <span class="required">*</span></label>
          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="2"/>
              <path d="M12 2v8m0 4v8"/>
              <path d="M8 8l-4-4M8 16l-4 4M16 8l4-4M16 16l4 4"/>
            </svg>
            <input id="transmissionType" type="text" formControlName="transmissionType" placeholder="e.g., Automatic"
              (input)="onComboInput('transmissionType',$event)" (focus)="onComboFocus('transmissionType')" (blur)="onComboBlur('transmissionType')" (keydown)="onComboKeyDown($event,'transmissionType')">
          </div>

          <div *ngIf="showTransmissionList && filteredTransmissions.length" class="combo-list">
            <div *ngFor="let opt of filteredTransmissions; let i = index"
                 class="combo-item"
                 [class.highlight]="i === highlightedTransmissionIndex"
                 (mousedown)="selectComboSuggestion('transmissionType', opt)">
              {{ opt }}
            </div>
          </div>

          <div class="error-message" *ngIf="addVehicleForm.get('transmissionType')?.invalid && (addVehicleForm.get('transmissionType')?.dirty || addVehicleForm.get('transmissionType')?.touched)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span *ngIf="addVehicleForm.get('transmissionType')?.errors?.['required']">Transmission type is required</span>
          </div>
        </div>
        
        <div class="form-group combobox">
          <label for="fuelType">Fuel Type <span class="required">*</span></label>
          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 22V8l5-5 5 5v14"/>
              <path d="M13 8v14"/>
              <path d="M5 12h6"/>
              <path d="M5 16h6"/>
              <path d="M18 6l3-3"/>
              <path d="M19 9h2v3"/>
            </svg>
            <input id="fuelType" type="text" formControlName="fuelType" placeholder="e.g., Gasoline"
              (input)="onComboInput('fuelType',$event)" (focus)="onComboFocus('fuelType')" (blur)="onComboBlur('fuelType')" (keydown)="onComboKeyDown($event,'fuelType')">
          </div>

          <div *ngIf="showFuelList && filteredFuels.length" class="combo-list">
            <div *ngFor="let opt of filteredFuels; let i = index"
                 class="combo-item"
                 [class.highlight]="i === highlightedFuelIndex"
                 (mousedown)="selectComboSuggestion('fuelType', opt)">
              {{ opt }}
            </div>
          </div>

          <div class="error-message" *ngIf="addVehicleForm.get('fuelType')?.invalid && (addVehicleForm.get('fuelType')?.dirty || addVehicleForm.get('fuelType')?.touched)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span *ngIf="addVehicleForm.get('fuelType')?.errors?.['required']">Fuel type is required</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Section: Registration Details -->
    <div class="form-section">
      <div class="section-label">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="7" width="20" height="10" rx="2"/>
          <path d="M7 12h10"/>
        </svg>
        <span>Registration Details</span>
      </div>

      <!-- Row 4: License Plate and Current Mileage -->
      <div class="form-row">
        <div class="form-group">
          <label for="licensePlate">License Plate <span class="required">*</span></label>
          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="10" rx="2"/>
              <line x1="7" y1="12" x2="17" y2="12"/>
            </svg>
            <input type="text" id="licensePlate" formControlName="licensePlate" placeholder="e.g., ABC1234 or ابج١٢٣٤"
              maxlength="7" (input)="onPlateInput($event)" autocomplete="off">
          </div>
          
          <div class="error-message" *ngIf="addVehicleForm.get('licensePlate')?.invalid && (addVehicleForm.get('licensePlate')?.dirty || addVehicleForm.get('licensePlate')?.touched)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span *ngIf="addVehicleForm.get('licensePlate')?.errors?.['required']">License plate is required</span>
            <span *ngIf="addVehicleForm.get('licensePlate')?.errors?.['maxlength']">Cannot exceed 7 characters</span>
            <span *ngIf="addVehicleForm.get('licensePlate')?.errors?.['plateFormat']">Format must be 2–3 letters (English or Arabic) followed by 3–4 digits</span>
            <span *ngIf="addVehicleForm.get('licensePlate')?.errors?.['licenseNotUnique']">This plate is already registered</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="mileage">Current Mileage <span class="required">*</span></label>
          <div class="input-wrapper">
            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            <input type="text" inputmode="numeric" id="mileage" formControlName="mileage" placeholder="e.g., 45000 or ٤٥٠٠٠" (input)="onMileageInput($event)">
            <span class="input-suffix">km</span>
          </div>
          
          <div class="error-message" *ngIf="addVehicleForm.get('mileage')?.invalid && (addVehicleForm.get('mileage')?.dirty || addVehicleForm.get('mileage')?.touched)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span *ngIf="addVehicleForm.get('mileage')?.errors?.['required']">Mileage is required</span>
            <span *ngIf="addVehicleForm.get('mileage')?.errors?.['min']">Must be non-negative</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="submit-btn" [disabled]="isSubmitting || addVehicleForm.invalid">
      <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      <span>{{ isSubmitting ? 'Adding Vehicle...' : 'Add Vehicle' }}</span>
      <div class="btn-shine"></div>
    </button>
  </form>
</div>